public class CsvUtil {

    // New method: pass delimiter
    public static List<Map<String,String>> parseCsv(Id contentVersionId, String delimiter) {
        ContentVersion cv = [
            SELECT VersionData, PathOnClient
            FROM ContentVersion
            WHERE Id = :contentVersionId
        ];

        // Auto-detect delimiter if not provided
        if (delimiter == null) {
            delimiter = cv.PathOnClient != null && cv.PathOnClient.endsWith('.txt') ? '\t' : ',';
        }

        String text = cv.VersionData.toString();
        List<String> rows = splitLines(text);

        List<String> headers = parseLine(rows[0].replace('\uFEFF',''), delimiter);

        List<Map<String,String>> result = new List<Map<String,String>>();

        for (Integer i = 1; i < rows.size(); i++) {
            if (String.isBlank(rows[i])) continue;

            List<String> cols = parseLine(rows[i], delimiter);
            Map<String,String> row = new Map<String,String>();

            for (Integer j = 0; j < headers.size(); j++) {
                row.put(headers[j], j < cols.size() ? cols[j].trim() : null);
            }
            result.add(row);
        }
        return result;
    }

    private static List<String> splitLines(String text) {
        List<String> lines = new List<String>();
        String current = '';

        for (Integer i = 0; i < text.length(); i++) {
            String c = text.substring(i, i+1);
            if (c == '\n') {
                lines.add(current);
                current = '';
            } else if (c != '\r') {
                current += c;
            }
        }
        if (current != '') lines.add(current);
        return lines;
    }

    private static List<String> parseLine(String line, String delimiter) {
        List<String> out = new List<String>();
        Boolean inQuotes = false;
        String cur = '';

        for (Integer i = 0; i < line.length(); i++) {
            String c = line.substring(i, i+1);
            if (c == '"') inQuotes = !inQuotes;
            else if (c == delimiter && !inQuotes) {
                out.add(cur);
                cur = '';
            } else cur += c;
        }
        out.add(cur);
        return out;
    }
}
